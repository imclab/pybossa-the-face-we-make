<style type="text/css">
    #throbber {
        padding: 10px;
        position:absolute;
        left: 45%;
        top:45%;
        margin: -50px 0 0 -50px;
        z-index: 10000;
        width: 100px;
        height: 100px;
    }
</style>

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <!-- Question, task id, photo and action buttons for answering the question-->
    <div class="span6 offset2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved</strong>
    </div>
    <div id="taskcompleted" class="alert alert-info" style="display:none;">
        <strong>The task has been completed!</strong> Thanks a lot!</strong>
</div>

<div id="finish" class="alert alert-success" style="display:none;">
    <strong>Congratulations!</strong> You have participated in all available tasks!</strong>
<br/>
<div class="alert-actions">
    <a class="btn small" href="/">Go back</a>
    <a class="btn small" href="/app">or, Check other applications</a>
</div>
    </div>
    <div id="error" class="alert alert-error" style="display:none;">
<a class="close">×</a>
<strong>Error!</strong> Something went wrong, please contact the site administrators</strong>
    </div>
  </div> <!-- End Success and Error Messages for the user -->
</div>


<div id="throbber"></div>

<div class="row skeleton">
  <div id="question" class="span12">
      <h1>Question</h1>
  </div>
</div>

<style>
    #answer button {
        width: 72px;
    }
    #answer2 button {
        width: 72px;
    }
</style>

<div class="row skeleton" style="padding-top:10px;">
      <!-- Answer buttons -->
      <div  class="span5">
          <div id="answer">
          <button class="btn btn-large" onclick="submitTask('tongue')">:-P</button>
          <button class="btn btn-large" onclick="submitTask('kiss')">:-*</button>
          <button class="btn btn-large" onclick="submitTask('cry')">:~(</button>
          <button class="btn btn-large" onclick="submitTask('sad')">:-(</button>
          <button class="btn btn-large" onclick="submitTask('wink')">;-)</button>
          </div>
          <div id="answer2" style="padding-top:3px;">
          <button class="btn btn-large" onclick="submitTask('surprised')">:-O</button>
          <button class="btn btn-large" onclick="submitTask('disappointed')">:-|</button>
          <button class="btn btn-large" onclick="submitTask('angry')">:-@</button>
          <button class="btn btn-large" onclick="submitTask('grin')">:-D</button>
          <button class="btn btn-large" onclick="submitTask('smile')">:-)</button>
          </div>
          <div id="answer3" style="padding-top:3px; text-align:center;">
          <button class="btn btn-large" onclick="submitTask('dontknow')">I don't know</button>
          </div>
          <div style="height:42px;">
           <hr>
           <p style="font-size:24px;">Your answer is: <span id="correct" style="display:none"><i class="icon-thumbs-up"></i> Correct!</span><span id="wrong" style="display:none"> <i class="icon-thumbs-down"></i>Wrong!</span></p>
          </div>
          <div>
            <hr>
            <h5><strong>Your progress</strong></h5>
            <p>You are working now on task: <span id="task-id" class="label label-warning">#</span></p>
            <p>You have completed: <span id="done" class="label label-info"></span> tasks from
            <span id="total" class="label label-inverse"></span></p>
            <div class="progress progress-striped">
                <div id="progress" rel="tooltip" title="#" class="bar" style="width: 0%;"></div>
            </div>
          </div>
      </div>
  <div class="span3" style="text-align:center">
    <img id="photo" class="img-circle" src="http://img339.imageshack.us/img339/9017/loadingo.png" style="max-width=100%">
    <p>
    Copyright © <a href="http://www.flickr.com/photos/thefacewemake">The Face We Make</a>
    </p>
    <p>by <a href="http://dxtr.com">Dexter Miranda</a>
    </p>
  </div>
  <div class="span2">
  </div>
</div>

<script src="/static/js/pybossa/pybossa.js" type="text/javascript"></script>
<script src="/static/js/throbber/throbber.js" type="text/javascript"></script>
<script>
var appname = 'thefacewemake';
var spinner = new Throbber({
    color: 'black',
    size: 90
});

// The spinner is attached to a div overlayed in top of the photo. 
// This div is only shown when the spinner is active, 
// otherwise, the div is hidden from the view to show the photo.¬

spinner.appendTo (document.getElementById('throbber'));

var taskAnswer = "";

// This function shows the spinner div and starts its animation¬
function spinnerStart() {
    $("#throbber").show();
    spinner.start();
    console.log("Spinner started!");
}

// This function stops the spinner and hides the spinner div¬
function spinnerStop() {
    spinner.stop()
    $("#throbber").hide();
    console.log("Spinner stopped!");
}
// Function to load the TaskRun data into the HTML skeleton
function loadData( task ) {
    taskAnswer = "Cleaned!";
    if ( !$.isEmptyObject(task) ) {
        if (task.state=='completed') {
            $('#answer').hide();
            $('#disqus_thread').hide();
            $('#taskcompleted').show();
        }
        loadUserProgress();
        setTimeout(function() { $("#wrong").fadeOut() }, 1000);
        setTimeout(function() { $("#correct").fadeOut() }, 1000);
        $("#question h1").text(task.info.question);
        $("#task-id").text(task.id);
        $("#photo-link").attr("href", task.info.link);
        $("#photo").attr("src", task.info.url_b);
        taskAnswer = task.info.photo_info['photo']['description']['_content'].toLowerCase();
    }
    else {
        $(".skeleton").hide();
        $("#finish").fadeIn();
    }
}

function loadTask( task_id ) {
    // Uncomment next line for debugging purposes
    //console.log( data );
    var t = $.ajax({
        url: '/api/task/'+task_id,
        dataType: 'json'
    });
    t.done( loadData );
}

function loadUserProgress() {
    pybossa.userProgress(appname).done(function(data){
        var pct = Math.round((data.done*100)/data.total);
        $("#progress").css("width", pct.toString() +"%");
        $("#progress").attr("title", pct.toString() + "% completed!");
        $("#progress").tooltip({'placement': 'left'}); 
        $("#total").text(data.total);
        $("#done").text(data.done);
    });
}

// Function to submit and save the TaskRun in PyBossa
function submitTask(answer) {
    // Get the task-id
    var taskid = $("#task-id").text();

    if (answer != 'dontknow') {
        if (taskAnswer.indexOf(answer) != -1) {
            $("#correct").show();
        }
        else {
            $("#wrong").show();
        }
    }
    // Save the task
    answer = {answer:answer, photo:$("#photo").attr("src")};
    pybossa.saveTask(taskid, answer).done( function( data ) {
        // Uncoment next line for debugging purposes
        //console.log("Answer saved!");
        // FadeIn & Out the success div feedback
        //$("#success").fadeIn();
        //setTimeout(function() { $("#success").fadeOut() }, 2000);
        // Load a new task
        pybossa.newTask(appname).done( function( data ){ loadData( data.task ) });
        //window.location.pathname = "/app/" + appname + "/newtask";
    });
}

// Check if the user is loading directly a task or requesting a new one
var taskId = pybossa.getCurrentTaskId(window.location.pathname);

if (taskId){
    // The user is loading directly a task, so load then input data
    loadTask(taskId);
}
else {
    // The user is requesting a new task, so get a new one
    pybossa.newTask(appname).done( function( data ) { 

        if ( !$.isEmptyObject(data.task) ) {
            //window.location.pathname = "/app/" + appname + "/task/" + data.task.id;
            history.pushState({},"Title","/app/" + appname + "/task/" + data.task.id);
            loadData(data.task);
        }
        else {
            $(".skeleton").hide();
            $("#finish").fadeIn();
        }
    });
}
</script>
